{% extends 'home/base.html' %}
{% block title %}‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ¬∑ Eventflow{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<style>
  /* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á Input ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Create */
  input[type="text"], input[type="number"], textarea, select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    background-color: #f8fafc;
    transition: all 0.2s;
    outline: none;
  }
  input:focus, textarea:focus {
    background-color: #ffffff;
    border-color: #3f72af;
    box-shadow: 0 0 0 4px rgba(63, 114, 175, 0.1);
  }
  /* ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÉ‡∏ô input number */
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
</style>

<div class="max-w-5xl mx-auto px-4 py-10">
  
  <div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4 border-b pb-6">
    <div>
      <h1 class="text-3xl font-black text-[#112d4e] tracking-tight">EDIT <span class="text-[#3f72af]">VENUE</span></h1>
      <p class="text-gray-500 mt-2 text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á <span class="font-bold text-[#112d4e]">{{ form.instance.name }}</span> ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
    </div>
    <a href="{% url 'venue_detail' form.instance.pk %}" class="flex items-center gap-2 text-sm font-bold text-gray-400 hover:text-[#112d4e] transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
      ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    </a>
  </div>

  <form method="post" enctype="multipart/form-data" class="space-y-10">
    {% csrf_token %}

    <section class="bg-white rounded-3xl border border-gray-100 shadow-sm p-8">
      <div class="flex items-center gap-3 mb-8">
        <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-[#3f72af]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
        </div>
        <h2 class="text-xl font-bold text-[#112d4e]">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h2>
      </div>

      {% if form.non_field_errors %}
        <div class="mb-6 rounded-2xl bg-red-50 text-red-600 p-4 text-sm font-medium border border-red-100">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for field in form %}
          {% if field.name not in 'code latitude longitude extra_amenities' %}
            <div class="{% if field.name == 'name' or field.name == 'description' or field.name == 'address' %}md:col-span-2{% endif %}">
              <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-1 tracking-wider">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}<p class="text-xs text-red-500 mt-1 font-medium">√ó {{ field.errors|striptags }}</p>{% endif %}
            </div>
          {% endif %}
        {% endfor %}
        {% if form.code %}{{ form.code.as_hidden }}{% endif %}
      </div>
    </section>

    <section class="bg-white rounded-3xl border border-gray-100 shadow-sm p-8">
      <div class="flex items-center gap-3 mb-8">
        <div class="w-10 h-10 bg-yellow-50 rounded-xl flex items-center justify-center text-yellow-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-7.714 2.143L11 21l-2.286-6.857L1 12l7.714-2.143L11 3z" /></svg>
        </div>
        <h2 class="text-xl font-bold text-[#112d4e]">‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å</h2>
      </div>
      
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for a in amenity_form %}
          <div class="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition group">
            <div class="flex items-center">{{ a }}</div>
            <label class="text-sm text-gray-600 group-hover:text-[#112d4e] transition cursor-pointer">{{ a.label }}</label>
          </div>
        {% endfor %}
      </div>
      <div class="mt-8 pt-8 border-t border-dashed">
        <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-1 tracking-wider">{{ form.extra_amenities.label }}</label>
        {{ form.extra_amenities }}
      </div>
    </section>

    <section class="bg-white rounded-3xl border border-gray-100 shadow-sm p-8"
             x-data="{
               latInput: null, lngInput: null, addrInput: null, allowAuto: true, map: null, marker: null,
               async reverseGeo(lat, lng) {
                 const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=th&addressdetails=1`;
                 try {
                    let res = await fetch(url);
                    let data = await res.json();
                    return data.display_name || null;
                 } catch(e) { return null; }
               },
               setPoint(lat, lng, fillAddr=false) {
                 if(this.latInput) this.latInput.value = Number(lat).toFixed(6);
                 if(this.lngInput) this.lngInput.value = Number(lng).toFixed(6);
                 if(fillAddr && this.addrInput && this.allowAuto) {
                   this.reverseGeo(lat, lng).then(addr => { if(addr) this.addrInput.value = addr; });
                 }
               },
               placeMarker(lat, lng, fillAddr=false) {
                 if(!this.marker) {
                   this.marker = L.marker([lat, lng], {draggable:true}).addTo(this.map);
                   this.marker.on('dragend', e => {
                     const pos = e.target.getLatLng();
                     this.setPoint(pos.lat, pos.lng, true);
                   });
                 } else {
                   this.marker.setLatLng([lat, lng]);
                 }
                 this.setPoint(lat, lng, fillAddr);
               },
               getCurrentLocation() {
                 if(!navigator.geolocation) return;
                 navigator.geolocation.getCurrentPosition(pos => {
                   const lat = pos.coords.latitude;
                   const lng = pos.coords.longitude;
                   this.placeMarker(lat, lng, true);
                   this.map.flyTo([lat, lng], 17);
                 });
               },
               init() {
                 this.latInput = document.getElementById('id_latitude') || document.querySelector('[name=latitude]');
                 this.lngInput = document.getElementById('id_longitude') || document.querySelector('[name=longitude]');
                 this.addrInput = document.getElementById('id_address') || document.querySelector('[name=address]');
                 const oldLat = parseFloat(this.latInput?.value);
                 const oldLng = parseFloat(this.lngInput?.value);
                 const hasPoint = Number.isFinite(oldLat) && Number.isFinite(oldLng);
                 const startLat = hasPoint ? oldLat : 13.736717;
                 const startLng = hasPoint ? oldLng : 100.523186;

                 this.map = L.map(this.$refs.mapEl).setView([startLat, startLng], hasPoint ? 17 : 13);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(this.map);

                 if(hasPoint) {
                   this.allowAuto = !this.addrInput || this.addrInput.value.trim() === '';
                   this.placeMarker(oldLat, oldLng, false); 
                 }
                 this.map.on('click', e => {
                   this.placeMarker(e.latlng.lat, e.latlng.lng, true);
                   this.map.flyTo(e.latlng, 17);
                 });
                 if(this.addrInput) {
                    this.addrInput.addEventListener('input', () => this.allowAuto = this.addrInput.value.trim() === '');
                 }
                 // Fix ‡∏à‡∏≠‡∏Ç‡∏≤‡∏ß
                 setTimeout(() => { this.map.invalidateSize(); }, 300);
               }
             }"
             x-init="init()">

      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /></svg>
          </div>
          <h2 class="text-xl font-bold text-[#112d4e]">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î</h2>
        </div>
        <button type="button" @click="getCurrentLocation()" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-emerald-500 text-emerald-600 rounded-xl text-sm font-bold hover:bg-emerald-50 transition">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 order-2 lg:order-1">
          <div x-ref="mapEl" class="w-full rounded-2xl h-[450px] border border-gray-100 shadow-inner z-0 overflow-hidden"></div>
        </div>
        <div class="space-y-6 order-1 lg:order-2">
          <div class="bg-blue-50/50 p-5 rounded-2xl border border-blue-100">
            <p class="text-xs text-[#3f72af] leading-relaxed">
              <strong>üìç ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            </p>
          </div>
          <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-1 tracking-wider">{{ form.latitude.label }}</label>{{ form.latitude }}</div>
          <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-1 tracking-wider">{{ form.longitude.label }}</label>{{ form.longitude }}</div>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-3xl border border-gray-100 shadow-sm p-8">
      <div class="flex items-center gap-3 mb-8">
        <div class="w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center text-purple-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
        </div>
        <h2 class="text-xl font-bold text-[#112d4e]">‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å {{ images_left }} ‡∏ä‡πà‡∏≠‡∏á)</h2>
      </div>

      {{ image_formset.management_form }}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for f in image_formset.forms %}
          <div class="relative group border-2 border-dashed border-gray-100 rounded-3xl p-6 bg-gray-50/50 hover:bg-white transition-all">
            {{ f.id }}
            <label class="block text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà {{ forloop.counter }}</label>
            <div class="mb-4">{{ f.image }}</div>
            
            {% if f.instance.pk %}
              <div class="mt-4 pt-4 border-t flex items-center gap-4">
                <img src="{{ f.instance.image.url }}" class="h-24 w-24 object-cover rounded-2xl shadow-sm border border-white">
                {% if f.fields.DELETE %}
                  <label class="inline-flex items-center gap-2 text-red-500 font-bold text-xs cursor-pointer hover:bg-red-50 p-2 rounded-lg transition">
                    {{ f.DELETE }} <span class="uppercase tracking-widest">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ</span>
                  </label>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </section>

    <div class="flex flex-col md:flex-row items-center justify-end gap-4 pt-4">
      <a href="{% url 'venue_detail' form.instance.pk %}" class="w-full md:w-auto text-center px-8 py-4 font-bold text-gray-400 hover:text-red-500 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
      <button type="submit" class="w-full md:w-auto bg-[#112d4e] text-white px-12 py-4 rounded-2xl font-black shadow-xl shadow-blue-900/20 hover:bg-[#3f72af] transform hover:-translate-y-1 transition-all active:scale-95">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
    </div>
  </form>
</div>
{% endblock %}