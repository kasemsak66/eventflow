{% extends 'home/base.html' %}
{% load static %}
{% block title %}‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ¬∑ Eventflow{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<div class="max-w-6xl mx-auto px-4"
     x-data="{
        venues: [],
        map: null,
        bounds: null,
        
        // --- 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
        init() {
          // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏à‡∏≤‡∏Å Django Script Tag ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
          const rawEl = document.getElementById('venues-data');
          try {
            this.venues = JSON.parse(rawEl.textContent) || [];
          } catch (e) { this.venues = []; }

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
          this.map = L.map(this.$refs.mapEl).setView([13.736717, 100.523186], 6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(this.map);
          
          this.bounds = L.latLngBounds(); // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï

          // --- 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î (Pins) ---
          let pinCount = 0;
          this.venues.forEach(v => {
            const lat = parseFloat(v.latitude);
            const lng = parseFloat(v.longitude);
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            if (Number.isFinite(lat) && Number.isFinite(lng)) {
              L.marker([lat, lng], { title: v.name })
                .addTo(this.map)
                .bindPopup(`
                  <div class='text-sm min-w-[150px]'>
                    <div class='font-bold text-[#112d4e]'>${v.name}</div>
                    <div class='text-gray-500 text-xs mb-2'>Code: ${v.code}</div>
                    <a href='/venues/${v.id}/' class='text-[#3f72af] hover:underline block'>üëâ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
                  </div>
                `);
              
              this.bounds.extend([lat, lng]); // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
              pinCount++;
            }
          });

          // --- 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏∏‡∏î ---
          if (pinCount > 0) {
            this.map.fitBounds(this.bounds.pad(0.1));
          }
        },

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô
        locateMe() {
          if (!navigator.geolocation) return;
          navigator.geolocation.getCurrentPosition(pos => {
             const lat = pos.coords.latitude, lng = pos.coords.longitude;
             L.marker([lat, lng]).addTo(this.map).bindPopup('‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà').openPopup();
             this.map.flyTo([lat, lng], 15);
          });
        }
     }">

  <div class="mb-4 flex items-center justify-between">
    <h1 class="text-2xl font-bold text-[#112d4e]">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>
    <div class="flex gap-3">
      <button @click="locateMe()" class="px-3 py-1.5 text-sm border rounded hover:bg-gray-50">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
      <a href="{% url 'venue_list' %}" class="text-sm text-[#3f72af] hover:underline pt-2">‚Üê ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
    </div>
  </div>

  <div x-ref="mapEl" class="w-full rounded-2xl shadow-lg border border-gray-200" style="height: 75vh;"></div>
  
  <p class="text-center text-gray-400 text-xs mt-2">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î Latitude/Longitude ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
</div>

{{ venues|json_script:"venues-data" }}

{% endblock %}