{% extends 'home/base.html' %}

{% block title %}‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-white shadow p-6 rounded-xl space-y-5" id="upload-slip"
     data-required="{{ booking.total_price|floatformat:2 }}"
     data-approved-ts="{% if booking.approved_at %}{{ booking.approved_at|date:'U' }}{% endif %}">
  <h1 class="text-2xl font-bold text-[#112d4e]">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h1>

  <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î -->
  <div class="text-sm text-gray-700">
    <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: <b>{{ booking.venue.name }}</b></p>
    <p>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <b id="required-amount">{{ booking.total_price }}</b> ‡∏ö‡∏≤‡∏ó</p>

    {# ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏¢ + ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å approved_at) #}
    {% if booking.approved_at %}
      <div class="mt-2 text-sm">
        <span class="font-medium text-[#112d4e]">‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞/‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô:</span>
        <time id="deadline-time"></time>
        <span id="deadline-countdown" class="text-gray-500"></span>
      </div>
      <hr class="my-3">
    {% else %}
      <hr class="my-3">
    {% endif %}

    {% if booking.venue.owner.bank_qr %}
      <p class="mb-1">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô:</p>
      <img src="{{ booking.venue.owner.bank_qr.url }}" alt="QR Code" class="w-56 border rounded">
    {% else %}
      <p class="mb-1">üí≥ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô</p>
      <p>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: <b>{{ booking.venue.owner.bank_name|default:"-" }}</b></p>
      <p>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: <b>{{ booking.venue.owner.bank_account_number|default:"-" }}</b></p>
    {% endif %}
  </div>

  <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ -->
  <form method="post" enctype="multipart/form-data" class="space-y-4" id="slip-form">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="rounded-md bg-red-50 border border-red-200 text-red-700 text-sm p-3">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div>
      <label class="block text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô <span class="text-red-600">*</span></label>
      <div class="text-xs text-gray-500 mb-1">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (<span id="hint-required">{{ booking.total_price }}</span> ‡∏ö‡∏≤‡∏ó)</div>
      {{ form.amount_paid }}
      {% if form.amount_paid.errors %}
        <p class="mt-1 text-xs text-red-600">{{ form.amount_paid.errors|join:", " }}</p>
      {% endif %}
    </div>

    <div>
      <label class="block text-sm font-medium">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ <span class="text-red-600">*</span></label>
      {{ form.payment_slip }}
      {% if form.payment_slip.errors %}
        <p class="mt-1 text-xs text-red-600">{{ form.payment_slip.errors|join:", " }}</p>
      {% endif %}
      <p class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .jpg, .png, .jpeg</p>
    </div>

    <div class="flex gap-3 pt-2">
      <button type="submit" id="submit-btn"
              class="bg-[#3f72af] hover:bg-[#2c5282] disabled:opacity-60 disabled:cursor-not-allowed
                     text-white px-4 py-2 rounded-lg">
        ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
      </button>
      <a href="{% url 'booking_list' %}" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </a>
    </div>
  </form>
</div>

{# ===== JS: ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ Asia/Bangkok ‡πÅ‡∏ö‡∏ö‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô ===== #}
<script>
(function () {
  const root = document.getElementById('upload-slip');
  if (!root) return;

  // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á DB ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á MySQL Event ‡πÑ‡∏ß‡πâ (‡πÄ‡∏ä‡πà‡∏ô 24 ‡∏ä‡∏°.)
  const PAY_HOURS = 24;

  // ---- helper ----
  const thDT = new Intl.DateTimeFormat('th-TH', {
    timeZone: 'Asia/Bangkok',
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false
  });
  const fmtNum = (n) => Number(n).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // 1) ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞
  const required = parseFloat(root.dataset.required || '0');
  const amountInput = document.querySelector('[name="amount_paid"]');
  const submitBtn = document.getElementById('submit-btn');

  function validateAmount() {
    if (!amountInput) return;
    const val = parseFloat(amountInput.value);
    const ok = !isNaN(val) && Math.abs(val - required) < 0.005; // ‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏° 0.005 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô floating
    submitBtn.disabled = !ok;
    submitBtn.title = ok ? '' : `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö ${fmtNum(required)} ‡∏ö‡∏≤‡∏ó`;
  }
  if (amountInput) {
    if (!amountInput.value) amountInput.placeholder = required.toFixed(2);
    amountInput.addEventListener('input', validateAmount);
    validateAmount();
  }

  // 2) ‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢: base = approved_at (Unix sec) + PAY_HOURS
  const approvedTsStr = root.dataset.approvedTs;
  if (approvedTsStr) {
    const approvedMs = parseInt(approvedTsStr, 10) * 1000; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    if (!isNaN(approvedMs)) {
      const deadlineMs = approvedMs + PAY_HOURS * 3600 * 1000;
      const deadlineEl = document.getElementById('deadline-time');
      const countdownEl = document.getElementById('deadline-countdown');

      function fmtCountdown(ms) {
        if (ms <= 0) return '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
        const s = Math.floor(ms / 1000);
        const d = Math.floor(s / 86400);
        const h = Math.floor((s % 86400) / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        if (d > 0) return `${d} ‡∏ß‡∏±‡∏ô ${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        if (h > 0) return `${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        if (m > 0) return `${m} ‡∏ô‡∏≤‡∏ó‡∏µ ${sec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        return `${sec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
      }

      function tick() {
        const nowMs = Date.now();
        // ‡πÅ‡∏™‡∏î‡∏á deadline ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
        deadlineEl.textContent = thDT.format(new Date(deadlineMs));
        // ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
        const msLeft = deadlineMs - nowMs;
        countdownEl.textContent = ` (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${fmtCountdown(msLeft)})`;
        countdownEl.classList.toggle('text-red-600', msLeft <= 5 * 60 * 1000);
      }

      tick();
      setInterval(tick, 1000);
    }
  }
})();
</script>
{% endblock %}
