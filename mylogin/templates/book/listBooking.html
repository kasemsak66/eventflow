{% extends 'home/base.html' %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-12" id="booking-page"
     data-pay-hours="24" data-confirm-hours="12">
  {# ‚Üë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ 24/12 ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö MySQL Event ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ #}

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏à‡∏≠‡∏á -->
  <section>
    <h1 class="text-2xl font-bold text-[#112d4e] mb-4">üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏à‡∏≠‡∏á</h1>

    {% if bookings %}
      <div class="grid gap-4">
        {% for b in bookings %}
          <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="font-semibold text-[#112d4e]">{{ b.venue.name }}</h2>
                <p class="text-sm text-gray-600">
                  {{ b.start_date }} - {{ b.end_date }} | {{ b.start_time }} - {{ b.end_time }}
                </p>
                <p class="text-sm text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ b.get_status_display }}</p>

                {# ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ #}
                {% if b.approved_at %}
                  <p class="text-xs text-gray-400">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ b.approved_at|date:"d/m/Y H:i" }}</p>
                {% endif %}
                {% if b.slip_uploaded_at %}
                  <p class="text-xs text-gray-400">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ b.slip_uploaded_at|date:"d/m/Y H:i" }}</p>
                {% endif %}

                {# === ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏¢ + ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ === #}
                {% if b.status == 'approved' and b.approved_at %}
                  <div class="mt-2 text-sm">
                    <span class="font-medium text-[#112d4e]">‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞/‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô:</span>
                    <time class="deadline"
                          data-base="{{ b.approved_at|date:'c' }}"
                          data-kind="pay">
                      <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
                    </time>
                    <span class="countdown text-gray-500"
                          data-base="{{ b.approved_at|date:'c' }}"
                          data-kind="pay"></span>
                  </div>
                {% endif %}

                {% if b.status == 'awaiting_confirmation' and b.slip_uploaded_at %}
                  <div class="mt-2 text-sm">
                    <span class="font-medium text-[#112d4e]">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô:</span>
                    <time class="deadline"
                          data-base="{{ b.slip_uploaded_at|date:'c' }}"
                          data-kind="confirm">
                    </time>
                    <span class="countdown text-gray-500"
                          data-base="{{ b.slip_uploaded_at|date:'c' }}"
                          data-kind="confirm"></span>
                  </div>
                {% endif %}

                {% if b.notes %}
                  <p class="text-sm text-gray-500 mt-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: {{ b.notes }}</p>
                {% endif %}
              </div>

              <div class="flex flex-col gap-2 items-end">
                {% if b.status == 'approved' %}
                  <a href="{% url 'booking_upload_slip' b.pk %}"
                     class="px-3 py-2 rounded-lg border text-sm hover:bg-gray-50">
                    ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ / ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                  </a>
                {% endif %}

                {% if b.status == 'pending' %}
                  <a href="{% url 'booking_delete' b.pk %}"
                     class="text-sm text-red-500 hover:underline">
                    ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                  </a>
                {% endif %}
              </div>
            </div>

            {% if b.status == 'awaiting_confirmation' %}
              <div class="mt-3 text-sm">
                <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞: {{ b.amount_paid|default:"-" }}</p>
                {% if b.payment_slip %}
                  <a href="{{ b.payment_slip.url }}" class="underline text-blue-600" target="_blank">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</a>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
    {% endif %}
  </section>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô -->
  <section>
    <h1 class="text-2xl font-bold text-[#112d4e] mb-4">üè† ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>

    {% if owner_bookings %}
      <div class="grid gap-4">
        {% for b in owner_bookings %}
          <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="font-semibold text-[#112d4e]">{{ b.venue.name }}</h2>
                <p class="text-sm text-gray-600">
                  ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: {{ b.user.get_full_name|default:b.user.email }}
                </p>
                <p class="text-sm text-gray-600">
                  {{ b.start_date }} - {{ b.end_date }} | {{ b.start_time }} - {{ b.end_time }}
                </p>
                <p class="text-sm text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ b.get_status_display }}</p>

                {% if b.approved_at %}
                  <p class="text-xs text-gray-400">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ b.approved_at|date:"d/m/Y H:i" }}</p>
                {% endif %}
                {% if b.slip_uploaded_at %}
                  <p class="text-xs text-gray-400">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ b.slip_uploaded_at|date:"d/m/Y H:i" }}</p>
                {% endif %}

                {# === ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏¢ + ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á === #}
                {% if b.status == 'approved' and b.approved_at %}
                  <div class="mt-2 text-sm">
                    <span class="font-medium text-[#112d4e]">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞/‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô:</span>
                    <time class="deadline"
                          data-base="{{ b.approved_at|date:'c' }}"
                          data-kind="pay"></time>
                    <span class="countdown text-gray-500"
                          data-base="{{ b.approved_at|date:'c' }}"
                          data-kind="pay"></span>
                  </div>
                {% endif %}

                {% if b.status == 'awaiting_confirmation' and b.slip_uploaded_at %}
                  <div class="mt-2 text-sm">
                    <span class="font-medium text-[#112d4e]">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô:</span>
                    <time class="deadline"
                          data-base="{{ b.slip_uploaded_at|date:'c' }}"
                          data-kind="confirm"></time>
                    <span class="countdown text-gray-500"
                          data-base="{{ b.slip_uploaded_at|date:'c' }}"
                          data-kind="confirm"></span>
                  </div>
                {% endif %}

                {% if b.notes %}
                  <p class="text-sm text-gray-500 mt-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: {{ b.notes }}</p>
                {% endif %}
              </div>

              <div class="flex flex-col gap-2 items-end">
                {% if b.status == 'pending' %}
                  <form action="{% url 'booking_approve_initial' b.pk %}" method="post">
                    {% csrf_token %}
                    <button class="px-3 py-2 rounded-lg bg-[#3f72af] text-white text-sm hover:opacity-90">
                      ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    </button>
                  </form>
                  <a class="text-xs underline text-gray-500" href="{% url 'profile_edit' %}">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/QR
                  </a>
                {% endif %}

                {% if b.status == 'awaiting_confirmation' %}
                  <div class="text-right text-sm">
                    <div>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å: {{ b.amount_paid|default:"-" }}</div>
                    {% if b.payment_slip %}
                      <a href="{{ b.payment_slip.url }}" class="underline text-blue-600" target="_blank">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>
                    {% else %}
                      <span class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ</span>
                    {% endif %}
                  </div>
                  <form action="{% url 'booking_confirm_payment' b.pk %}" method="post" class="mt-2">
                    {% csrf_token %}
                    <button class="px-3 py-2 rounded-lg bg-green-600 text-white text-sm hover:opacity-90">
                      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
                    </button>
                  </form>
                  <form action="{% url 'booking_reject' b.pk %}" method="post">
                    {% csrf_token %}
                    <button class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm hover:opacity-90">
                      ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                    </button>
                  </form>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    {% endif %}
  </section>

</div>

{# ===== JS: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì deadline + ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á ===== #}
<script>
(function () {
  const root = document.getElementById('booking-page');
  if (!root) return;

  // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö MySQL Event
  const PAY_HOURS = parseInt(root.dataset.payHours || '24', 10);         // ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -> ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏¢‡∏ä‡∏≥‡∏£‡∏∞
  const CONFIRM_HOURS = parseInt(root.dataset.confirmHours || '12', 10); // ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ -> ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì deadline ISO string ‡∏à‡∏≤‡∏Å base time + hours
  function calcDeadline(baseIso, kind) {
    const base = new Date(baseIso);
    if (isNaN(base)) return null;
    const deadline = new Date(base.getTime() + (kind === 'pay' ? PAY_HOURS : CONFIRM_HOURS) * 3600 * 1000);
    return deadline;
  }

  // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö dd/mm/yyyy HH:MM
  function fmtLocal(dt) {
    const pad = (n) => (n < 10 ? '0'+n : ''+n);
    return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
  function fmtCountdown(ms) {
    if (ms <= 0) return '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
    const s = Math.floor(ms / 1000);
    const d = Math.floor(s / 86400);
    const h = Math.floor((s % 86400) / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (d > 0) return `${d} ‡∏ß‡∏±‡∏ô ${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    if (h > 0) return `${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    if (m > 0) return `${m} ‡∏ô‡∏≤‡∏ó‡∏µ ${sec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
    return `${sec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
  }

  function tick() {
    const now = new Date();
    // ‡πÄ‡∏ï‡∏¥‡∏° <time.deadline>
    document.querySelectorAll('time.deadline').forEach(el => {
      const base = el.getAttribute('data-base');
      const kind = el.getAttribute('data-kind'); // pay | confirm
      const deadline = calcDeadline(base, kind);
      if (!deadline) return;
      el.textContent = fmtLocal(deadline);
      el.dateTime = deadline.toISOString();
    });
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï <span.countdown>
    document.querySelectorAll('span.countdown').forEach(el => {
      const base = el.getAttribute('data-base');
      const kind = el.getAttribute('data-kind');
      const deadline = calcDeadline(base, kind);
      if (!deadline) return;
      const msLeft = deadline.getTime() - now.getTime();
      el.textContent = ` (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${fmtCountdown(msLeft)})`;
      el.classList.toggle('text-red-600', msLeft <= 5 * 60 * 1000); // 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á
    });
  }

  tick();
  setInterval(tick, 1000);
})();
</script>
{% endblock %}
